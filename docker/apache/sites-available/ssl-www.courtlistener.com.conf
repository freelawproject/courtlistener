<VirtualHost *:443>
    ServerAdmin mike@courtlistener.com
    ServerName www.courtlistener.com
    DocumentRoot /var/www
    CustomLog /dev/stdout combined
    ErrorLog /dev/stdout
    LogLevel warn
    ServerSignature Off
    Protocols h2 http/1.1

    # Note: WSGI script needs to also be in the <Directory> config below
    #WSGIScriptAlias / /opt/courtlistener/docker/apache/wsgi-configs/python_version_test.py
    WSGIScriptAlias / /opt/courtlistener/docker/apache/wsgi-configs/cl.py
    WSGIDaemonProcess cl \
      threads=10 \
      processes=64 \
      python-path=/usr/local/lib/python3.8/site-packages/
    WSGIProcessGroup cl
    WSGIApplicationGroup %{GLOBAL}
    WSGIPassAuthorization On

    # Give apache access to the WSGI file
    <Directory /opt/courtlistener/docker/apache/wsgi-configs/>
        <Files cl.py>
            Require all granted
        </Files>
    </Directory>

    Alias /static/recap-thumbnails/ /var/www/cl/cl/assets/media/recap-thumbnails/
    Alias /static/                  /var/www/cl/cl/assets/static/
    Alias /api/bulk-data/           /var/www/cl/cl/assets/media/bulk-data/
    Alias /tools/sample-data/       /var/www/cl/cl/assets/media/sample-data/

    XSendFile on
    XSendFilePath /var/www/cl/cl/assets/

    # Disable ETags, since modified works similarly and does not fail in
    # a distributed environment
    Header unset ETag
    FileETag None

    # Use HTTP Strict Transport Security to force client to use secure connections only
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Force utf-8
    AddDefaultCharset utf-8
    AddCharset utf-8 .html .css .js .xml .json .rss .atom

    # Block bad bots
    RewriteEngine On
    RewriteCond %{HTTP_USER_AGENT}   ^Jaunt [OR]
    RewriteCond %{HTTP_USER_AGENT}   ^Sosospider [OR]
    RewriteCond %{HTTP_USER_AGENT} "^Mozilla/5\.0 \(Windows NT 10\.0; Win64; x64\) AppleWebKit/537\.36 \(KHTML, like Gecko\) Chrome/59\.0\.3071\.86 Safari/537\.36$" [OR]
    RewriteCond %{HTTP_USER_AGENT} "^Mozilla/5\.0 \(Windows NT 6\.1; Win64; x64\) AppleWebKit/537\.36 \(KHTML, like Gecko\) Chrome/60\.0\.3112\.78 Safari/537\.36$" [OR]
    RewriteCond %{HTTP_USER_AGENT} "^Mozilla/4\.0 \(compatible; MSIE 6\.0; Windows NT 5\.1; SV1\)$" [OR]
    RewriteCond %{HTTP_USER_AGENT} "^Mozilla/5\.0 \(compatible; MSIE 6\.0; Windows NT 5\.1; SV1\)$"
    RewriteRule ^/ http://127.0.0.1/ [R=301,L]
    RewriteRule ^/docket/5424004/* - [G]

    Redirect /bulk-financial-disclosures/ https://com-courtlistener-storage.s3-us-west-2.amazonaws.com/list.html?prefix=financial-disclosures/


    # Enable https
    SSLEngine on
    SSLProtocol            all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder    off

    # Current SSL Settings
    SSLCertificateFile /etc/letsencrypt/live/courtlistener.com/cert.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/courtlistener.com/privkey.pem

    <DirectoryMatch "^/var/www/cl/cl/assets/media/(sample-data|bulk-data)/">
        Options Indexes FollowSymLinks
        AllowOverride Limit
        Require all granted
    </Directory>
    <Location /server-status>
        SetHandler server-status
        Order deny,allow
        Require ip 192.168.0.0/16
    </Location>
</VirtualHost>
